{"version":3,"file":"urql-exchange-graphcache-default-storage.min.mjs","sources":["../src/default-storage/index.ts"],"sourcesContent":["import type {\n  SerializedEntries,\n  SerializedRequest,\n  StorageAdapter,\n} from '../types';\n\nconst getRequestPromise = <T>(request: IDBRequest<T>): Promise<T> => {\n  return new Promise((resolve, reject) => {\n    request.onerror = () => {\n      reject(request.error);\n    };\n\n    request.onsuccess = () => {\n      resolve(request.result);\n    };\n  });\n};\n\nconst getTransactionPromise = (transaction: IDBTransaction): Promise<any> => {\n  return new Promise((resolve, reject) => {\n    transaction.onerror = () => {\n      reject(transaction.error);\n    };\n\n    transaction.oncomplete = resolve;\n  });\n};\n\nexport interface StorageOptions {\n  /** Name of the IndexedDB database that will be used.\n   * @defaultValue `'graphcache-v4'`\n   */\n  idbName?: string;\n  /** Maximum age of cache entries (in days) after which data is discarded.\n   * @defaultValue `7` days\n   */\n  maxAge?: number;\n  /** Gets Called when the exchange has hydrated the data from storage. */\n  onCacheHydrated?: () => void;\n}\n\n/** Sample storage adapter persisting to IndexedDB. */\nexport interface DefaultStorage extends StorageAdapter {\n  /** Clears the entire IndexedDB storage. */\n  clear(): Promise<any>;\n}\n\n/** Creates a default {@link StorageAdapter} which uses IndexedDB for storage.\n *\n * @param opts - A {@link StorageOptions} configuration object.\n * @returns the created {@link StorageAdapter}.\n *\n * @remarks\n * The default storage uses IndexedDB to persist the normalized cache for\n * offline use. It demonstrates that the cache can be chunked by timestamps.\n *\n * Note: We have no data on stability of this storage and our Offline Support\n * for large APIs or longterm use. Proceed with caution.\n */\nexport const makeDefaultStorage = (opts?: StorageOptions): DefaultStorage => {\n  if (!opts) opts = {};\n\n  let callback: (() => void) | undefined;\n\n  const DB_NAME = opts.idbName || 'graphcache-v4';\n  const ENTRIES_STORE_NAME = 'entries';\n  const METADATA_STORE_NAME = 'metadata';\n\n  let batch: Record<string, string | undefined> = Object.create(null);\n  const timestamp = Math.floor(new Date().valueOf() / (1000 * 60 * 60 * 24));\n  const maxAge = timestamp - (opts.maxAge || 7);\n\n  const req = indexedDB.open(DB_NAME, 1);\n  const database$ = getRequestPromise(req);\n\n  req.onupgradeneeded = () => {\n    req.result.createObjectStore(ENTRIES_STORE_NAME);\n    req.result.createObjectStore(METADATA_STORE_NAME);\n  };\n\n  const serializeEntry = (entry: string): string => entry.replace(/:/g, '%3a');\n\n  const deserializeEntry = (entry: string): string =>\n    entry.replace(/%3a/g, ':');\n\n  const serializeBatch = (): string => {\n    let data = '';\n    for (const key in batch) {\n      const value = batch[key];\n      data += serializeEntry(key);\n      data += ':';\n      if (value) data += serializeEntry(value);\n      data += ':';\n    }\n\n    return data;\n  };\n\n  const deserializeBatch = (input: string) => {\n    const data = {};\n    let char = '';\n    let key = '';\n    let entry = '';\n    let mode = 0;\n    let index = 0;\n    while (index < input.length) {\n      entry = '';\n      while ((char = input[index++]) !== ':' && char) {\n        entry += char;\n      }\n\n      if (mode) {\n        data[key] = deserializeEntry(entry) || undefined;\n        mode = 0;\n      } else {\n        key = deserializeEntry(entry);\n        mode = 1;\n      }\n    }\n\n    return data;\n  };\n\n  return {\n    clear() {\n      return database$.then(database => {\n        const transaction = database.transaction(\n          [METADATA_STORE_NAME, ENTRIES_STORE_NAME],\n          'readwrite'\n        );\n        transaction.objectStore(METADATA_STORE_NAME).clear();\n        transaction.objectStore(ENTRIES_STORE_NAME).clear();\n        batch = Object.create(null);\n        return getTransactionPromise(transaction);\n      });\n    },\n\n    readMetadata(): Promise<null | SerializedRequest[]> {\n      return database$.then(\n        database => {\n          return getRequestPromise<SerializedRequest[]>(\n            database\n              .transaction(METADATA_STORE_NAME, 'readonly')\n              .objectStore(METADATA_STORE_NAME)\n              .get(METADATA_STORE_NAME)\n          );\n        },\n        () => null\n      );\n    },\n\n    writeMetadata(metadata: SerializedRequest[]) {\n      database$.then(\n        database => {\n          return getRequestPromise(\n            database\n              .transaction(METADATA_STORE_NAME, 'readwrite')\n              .objectStore(METADATA_STORE_NAME)\n              .put(metadata, METADATA_STORE_NAME)\n          );\n        },\n        () => {\n          /* noop */\n        }\n      );\n    },\n\n    writeData(entries: SerializedEntries): Promise<void> {\n      Object.assign(batch, entries);\n      const toUndefined = () => undefined;\n\n      return database$\n        .then(database => {\n          return getRequestPromise(\n            database\n              .transaction(ENTRIES_STORE_NAME, 'readwrite')\n              .objectStore(ENTRIES_STORE_NAME)\n              .put(serializeBatch(), timestamp)\n          );\n        })\n        .then(toUndefined, toUndefined);\n    },\n\n    readData(): Promise<SerializedEntries> {\n      const chunks: string[] = [];\n      return database$\n        .then(database => {\n          const transaction = database.transaction(\n            ENTRIES_STORE_NAME,\n            'readwrite'\n          );\n\n          const store = transaction.objectStore(ENTRIES_STORE_NAME);\n          const request = (store.openKeyCursor || store.openCursor).call(store);\n\n          request.onsuccess = function () {\n            if (this.result) {\n              const { key } = this.result;\n              if (typeof key !== 'number' || key < maxAge) {\n                store.delete(key);\n              } else {\n                const request = store.get(key);\n                const index = chunks.length;\n                chunks.push('');\n                request.onsuccess = () => {\n                  const result = '' + request.result;\n                  if (key === timestamp)\n                    Object.assign(batch, deserializeBatch(result));\n                  chunks[index] = result;\n                };\n              }\n\n              this.result.continue();\n            }\n          };\n\n          return getTransactionPromise(transaction);\n        })\n        .then(\n          () => deserializeBatch(chunks.join('')),\n          () => batch\n        );\n    },\n    onCacheHydrated: opts.onCacheHydrated,\n    onOnline(cb: () => void) {\n      if (callback) {\n        window.removeEventListener('online', callback);\n        callback = undefined;\n      }\n\n      window.addEventListener(\n        'online',\n        (callback = () => {\n          cb();\n        })\n      );\n    },\n  };\n};\n"],"names":["getRequestPromise","request","Promise","resolve","reject","onerror","error","onsuccess","result","getTransactionPromise","transaction","oncomplete","makeDefaultStorage","opts","callback","DB_NAME","idbName","ENTRIES_STORE_NAME","METADATA_STORE_NAME","batch","Object","create","timestamp","Math","floor","Date","valueOf","maxAge","req","indexedDB","open","database$","onupgradeneeded","createObjectStore","serializeEntry","entry","replace","deserializeEntry","deserializeBatch","input","data","char","key","mode","index","length","undefined","clear","then","database","objectStore","readMetadata","get","writeMetadata","metadata","put","writeData","entries","assign","toUndefined","serializeBatch","value","readData","chunks","store","openKeyCursor","openCursor","call","this","delete","push","continue","join","onCacheHydrated","onOnline","cb","window","removeEventListener","addEventListener"],"mappings":"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"}