---
import BaseLayout from "@layouts/BaseLayout.astro";
import ServicesIcon from "@components/Services/ServicesIcon.astro";
import PodcastFeed from "@components/Podcasts/PodcastFeed.astro";
import type { PodcastEpisode } from "../types/podcast";

let latestEpisodes: PodcastEpisode[] = [];
let error: string | null = null;

try {
  // In development, check if we're using Netlify Dev server
  const baseUrl = import.meta.env.DEV 
    ? 'http://localhost:8888' // Netlify Functions dev server
    : '';

  const response = await fetch(`${baseUrl}/.netlify/functions/getPodcastFeeds`);
  
  if (!response.ok) {
    const errorData = await response.json().catch(() => ({}));
    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
  }
  
  latestEpisodes = await response.json();
} catch (e) {
  console.error('Error fetching podcast feeds:', e);
  
  if (import.meta.env.DEV) {
    error = 'Failed to fetch podcast feeds. Make sure to run "npm run dev:netlify" to start the Netlify Functions server.';
  } else {
    error = e.message === 'Timeout while fetching podcast feeds'
      ? 'The podcast feeds are taking longer than usual to load. Please try again in a moment.'
      : 'We\'re having trouble loading the podcast feeds right now. Please try again later.';
  }
}
---

<BaseLayout
  title="Guido's Podcasts"
  description="Overview of the podcasts that I host and produce."
>
  <ServicesIcon />
  
  <div class="mt-16">
    {error ? (
      <div class="text-center p-8 bg-red-50 rounded-lg">
        <p class="text-red-600 mb-4">{error}</p>
        <p class="text-base-500">In the meantime, you can visit the podcasts directly:</p>
        <div class="mt-4 space-y-2">
          <a href="https://sheeptank.transistor.fm/" class="text-primary-500 hover:underline block">Sheeptank</a>
          <a href="https://www.cro.cafe" class="text-primary-500 hover:underline block">CRO.CAFE</a>
        </div>
      </div>
    ) : (
      <PodcastFeed episodes={latestEpisodes} />
    )}
  </div>
</BaseLayout>
