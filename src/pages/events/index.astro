---
// layout
import BaseLayout from "@layouts/BaseLayout.astro";

// components
import Badge from "@components/Badge/Badge.astro";
import EventCard from "@components/Events/EventCard.astro";
import RecurringEventCard from "@components/Events/RecurringEventCard.astro";
import UpcomingEvents from "@components/Events/UpcomingEvents.astro";
import FeatureFlagsMarquee from "@components/Feature/FeatureFlagsMarquee.astro";

// utils
import { getPresentationUrl } from "@utils/eventPresentationRelations";
import { getAllEvents, getEventIcon } from "@utils/eventUtils";

// Get all events and sort them by date
const events = await getAllEvents();
const sortedEvents = [...events].sort((a, b) =>
  new Date(b.date).getTime() - new Date(a.date).getTime()
);

// Filter for past events only (before today)
const today = new Date();
today.setHours(0, 0, 0, 0);

const pastEvents = sortedEvents.filter((event) => new Date(event.date) < today);

// Identify recurring event patterns (Spryker User Group monthly events)
const RECURRING_EVENT_PATTERN = /^spryker-user-group-\d{4}-\d{2}$/;

// Group events by year and separate recurring events
interface YearGroup {
  year: number;
  regularEvents: typeof pastEvents;
  recurringGroups: Map<string, typeof pastEvents>;
}

// Type for combined events (regular + recurring groups)
interface CombinedEventItem {
  type: 'regular' | 'recurring';
  event?: typeof pastEvents[0];
  recurringKey?: string;
  recurringEvents?: typeof pastEvents;
  date: Date;
}

const eventsByYear = new Map<number, YearGroup>();

pastEvents.forEach((event) => {
  const year = new Date(event.date).getFullYear();

  if (!eventsByYear.has(year)) {
    eventsByYear.set(year, {
      year,
      regularEvents: [],
      recurringGroups: new Map()
    });
  }

  const yearGroup = eventsByYear.get(year)!;

  // Check if this is a recurring Spryker User Group event
  if (RECURRING_EVENT_PATTERN.test(event.id)) {
    const groupKey = 'spryker-user-group';
    if (!yearGroup.recurringGroups.has(groupKey)) {
      yearGroup.recurringGroups.set(groupKey, []);
    }
    yearGroup.recurringGroups.get(groupKey)!.push(event);
  } else {
    yearGroup.regularEvents.push(event);
  }
});

// Sort years descending
const sortedYears = Array.from(eventsByYear.keys()).sort((a, b) => b - a);

// Load the Spryker icon once for recurring event cards
const sprykerIcon = await getEventIcon('spryker.png');

// Calculate total event count for display
// Regular events + 1 per recurring group per year
let totalDisplayedEvents = 0;
sortedYears.forEach((year) => {
  const yearGroup = eventsByYear.get(year)!;
  totalDisplayedEvents += yearGroup.regularEvents.length;
  totalDisplayedEvents += yearGroup.recurringGroups.size; // Each recurring group counts as 1
});
---

<BaseLayout
  title="Events"
  description="Overview of all events"
  transition:animate="slide"
>
  {/* Upcoming Events Section */}
  <section class="py-24 md:py-28">
    <UpcomingEvents events={sortedEvents} />
  </section>

  {/* Countries Flags Section */}
  <section class="py-12">
    <FeatureFlagsMarquee />
  </section>

  {/* Past Events Section */}
  <section id="past-events" class="py-24 md:py-28">
    <div class="mx-auto mb-16 text-center md:max-w-4xl">
      <Badge>Events</Badge>
      <h1 class="h2 mb-4">Past Events</h1>
      <p class="description text-lg md:text-xl">
        An overview of all {totalDisplayedEvents} events I've spoken at
      </p>
    </div>

    <div class="space-y-16" id="events-container">
      {sortedYears.map((year) => {
        const yearGroup = eventsByYear.get(year)!;

        // Combine recurring groups and regular events for this year
        // Place recurring group card at the position of its first occurrence
        const allYearEvents: CombinedEventItem[] = [];

        // Add regular events
        yearGroup.regularEvents.forEach((event) => {
          allYearEvents.push({
            type: 'regular',
            event,
            date: new Date(event.date)
          });
        });

        // Add recurring groups (use the date of the last event in the group)
        yearGroup.recurringGroups.forEach((events, key) => {
          const lastEvent = events[0]; // Events are already sorted desc
          allYearEvents.push({
            type: 'recurring',
            recurringKey: key,
            recurringEvents: events,
            date: new Date(lastEvent.date)
          });
        });

        // Sort by date descending
        allYearEvents.sort((a, b) => b.date.getTime() - a.date.getTime());

        // Split into two columns
        const firstColumnEvents = allYearEvents.filter((_, i) => i % 2 === 0);
        const secondColumnEvents = allYearEvents.filter((_, i) => i % 2 === 1);

        return (
          <div class="year-group">
            <div class="flex items-center gap-4 mb-8">
              <h2 class="text-2xl font-bold text-base-800 dark:text-base-200">{year}</h2>
              <div class="flex-1 h-px bg-base-300 dark:bg-base-700"></div>
              <span class="text-sm text-base-500 dark:text-base-400">
                {allYearEvents.length} {allYearEvents.length === 1 ? 'event' : 'events'}
              </span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
              {/* First column */}
              <div class="space-y-6">
                {firstColumnEvents.map((item) => (
                  item.type === 'recurring' && item.recurringEvents ? (
                    <RecurringEventCard
                      name="Spryker User Group"
                      events={item.recurringEvents}
                      icon={sprykerIcon}
                      url="https://forum.commercequest.space/events/"
                      role="Organizer & co-host/moderator"
                    />
                  ) : item.event ? (
                    <EventCard
                      {...item.event}
                      showPresentationName={true}
                      presentationUrl={getPresentationUrl(item.event.id)}
                    />
                  ) : null
                ))}
              </div>

              {/* Second column - offset as a whole */}
              <div class="space-y-6 md:mt-24">
                {secondColumnEvents.map((item) => (
                  item.type === 'recurring' && item.recurringEvents ? (
                    <RecurringEventCard
                      name="Spryker User Group"
                      events={item.recurringEvents}
                      icon={sprykerIcon}
                      url="https://forum.commercequest.space/events/"
                      role="Organizer & co-host/moderator"
                    />
                  ) : item.event ? (
                    <EventCard
                      {...item.event}
                      showPresentationName={true}
                      presentationUrl={getPresentationUrl(item.event.id)}
                    />
                  ) : null
                ))}
              </div>
            </div>
          </div>
        );
      })}
    </div>
  </section>
</BaseLayout>
