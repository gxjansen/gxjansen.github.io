---
import { Image } from "astro:assets";
import type { Event } from "../../utils/eventUtils";
import { loadCountryFlag } from "../../utils/flagUtils";

interface Props extends Event {
  showPresentationName?: boolean; // Whether to show the presentation name
  presentationUrl?: string; // URL to the presentation if it exists
  isOnPresentationPage?: boolean; // Whether this card is shown on a presentation detail page
}

const {
  name,
  date,
  url,
  city,
  country,
  topic,
  role,
  workshop,
  loadedIcon,
  showPresentationName = true,
  presentationUrl,
  isOnPresentationPage = false,
} = Astro.props;

// Determine which URL to use for the link
const linkUrl = isOnPresentationPage ? url : presentationUrl || url;

// Prepare the content wrapper based on whether there's a URL
const WrapperTag = linkUrl ? "a" : "div";
const wrapperProps = linkUrl
  ? {
      href: linkUrl,
      target: "_blank",
      rel: "noopener noreferrer",
    }
  : {};

// Determine display text for topic/role
const displayText = topic || role;

// Define classes based on whether the card is clickable
const wrapperClasses = linkUrl ? "cursor-pointer" : "";

// Load country flag if country code is provided
const flagImage = country ? await loadCountryFlag(country) : null;

// Format date
const eventDate = new Date(date).toLocaleDateString("en-US", {
  month: "short",
  day: "numeric",
  year: "numeric",
});
---

<article class="event-card group" role="listitem">
  <WrapperTag {...wrapperProps} class={wrapperClasses}>
    <div class="mb-3 flex items-center">
      <div
        class="mr-3 flex h-10 w-10 items-center justify-center rounded-lg bg-base-300 dark:bg-base-800"
      >
        {
          loadedIcon ? (
            <Image
              src={loadedIcon}
              alt={`${name} Icon`}
              width={32}
              height={32}
              class="opacity-80 contrast-125 dark:opacity-90 dark:contrast-125"
              loading="lazy"
            />
          ) : (
            <span class="text-2xl">üóìÔ∏è</span>
          )
        }
      </div>
      <div class="flex flex-col">
        <div class="flex flex-wrap items-center gap-2">
          <div class="flex items-center gap-2">
            <span
              class="text-lg font-semibold text-primary-600 dark:text-primary-400"
            >
              {name}
            </span>
            {
              workshop && (
                <span class="rounded bg-primary-50 px-2 py-1 text-xs text-primary-600 dark:bg-primary-400/10 dark:text-primary-400">
                  Workshop
                </span>
              )
            }
            {
              linkUrl && (
                <span class="text-primary-600 transition-transform duration-200 group-hover:translate-x-1 dark:text-primary-400">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </span>
              )
            }
          </div>
        </div>
        <div
          class="flex flex-col text-sm text-base-600 sm:flex-row sm:items-center sm:gap-1 dark:text-base-300"
        >
          <div class="flex items-center gap-1">
            {
              flagImage ? (
                <Image
                  src={flagImage}
                  alt={`Flag of ${country}`}
                  width={16}
                  height={12}
                  class="mb-0 inline-block rounded-sm mix-blend-multiply dark:mix-blend-screen"
                  loading="lazy"
                />
              ) : (
                <span>üåé</span>
              )
            }
            <span>{city}</span>
          </div>
          <span class="hidden sm:inline">&mdash;</span>
          <span>{eventDate}</span>
        </div>
      </div>
    </div>
    <div class="mt-2 flex items-center gap-2">
      {
        !isOnPresentationPage && displayText && (
          <em class="line-clamp-1 flex-1 text-sm text-base-600 dark:text-base-400">
            {displayText}
          </em>
        )
      }

      {
        linkUrl && !isOnPresentationPage && presentationUrl && (
          <div class="flex items-center gap-1 text-xs text-base-500 transition-colors duration-200 group-hover:text-primary-600 dark:text-base-400 dark:group-hover:text-primary-400">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="size-4"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M21 3a1 1 0 0 1 0 2v9a3 3 0 0 1 -3 3h-5v2h2a1 1 0 0 1 0 2h-6a1 1 0 0 1 0 -2h2v-2h-5a3 3 0 0 1 -3 -3v-9a1 1 0 1 1 0 -2zm-4.293 4.293a1 1 0 0 0 -1.414 0l-2.293 2.292l-1.293 -1.292a1 1 0 0 0 -1.414 0l-3 3a1 1 0 0 0 0 1.414l.094 .083a1 1 0 0 0 1.32 -.083l2.293 -2.292l1.293 1.292a1 1 0 0 0 1.414 0l3 -3a1 1 0 0 0 0 -1.414" />
            </svg>
          </div>
        )
      }
    </div>
  </WrapperTag>
</article>
