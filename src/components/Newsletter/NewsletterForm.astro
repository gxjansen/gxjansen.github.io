---
/**
 * Reusable Newsletter Subscription Form Component
 * Integrates with self-hosted Listmonk instance
 *
 * Variants:
 * - inline: Horizontal form for embedding in content
 * - card: Standalone card with background and optional title/description
 * - cta: Full-width call-to-action style with dark background
 * - minimal: Just the form fields, no wrapper styling
 *
 * Best practices applied:
 * - Minimal fields (email only, name optional) to reduce friction
 * - Clear value proposition in default copy
 * - Trust signals (unsubscribe note, privacy)
 * - Accessible with ARIA labels and keyboard support
 * - ALTCHA proof-of-work spam protection (privacy-friendly)
 */

import { Icon } from "astro-icon";
import Button from "@components/Button/Button.astro";

const altchaChallengeUrl = "/.netlify/functions/altcha-challenge";

interface Props {
  /** Display variant */
  variant?: "inline" | "card" | "cta" | "minimal";
  /** Form title (used in card/cta variants) */
  title?: string;
  /** Form description (used in card/cta variants) */
  description?: string;
  /** Optional note below form (e.g., frequency, unsubscribe info) */
  note?: string;
  /** Listmonk list ID (integer) */
  listId?: number;
  /** Listmonk form action URL */
  actionUrl?: string;
  /** Show name field */
  showName?: boolean;
  /** Placeholder text for email */
  emailPlaceholder?: string;
  /** Placeholder text for name */
  namePlaceholder?: string;
  /** Submit button text */
  buttonText?: string;
  /** Show subscriber count as social proof */
  showSubscriberCount?: boolean;
  /** Additional CSS classes */
  class?: string;
}

const {
  variant = "card",
  title = "Stay in the loop",
  description = "Curated insights on community, experimentation, AI & open tech. No spam, no tracking pixels, unsubscribe anytime.",
  note = "You'll receive a confirmation email. No spam, unsubscribe anytime.",
  listId = 3, // Guido's Golden Nuggets
  actionUrl = "/.netlify/functions/newsletter-subscribe",
  showName = false, // Research shows fewer fields = more signups
  emailPlaceholder = "your@email.com",
  namePlaceholder = "Your name (optional)",
  buttonText = "Subscribe",
  showSubscriberCount = true,
  class: className,
} = Astro.props;

const formId = `newsletter-form-${Math.random().toString(36).slice(2, 9)}`;
const signupPage = Astro.url.pathname;
---

{variant === "card" && (
  <div
    class:list={[
      "newsletter-card rounded-lg bg-base-200 dark:bg-base-800 p-6 md:p-8",
      className
    ]}
  >
    {title && (
      <h3 class="text-xl md:text-2xl font-bold text-base-900 dark:text-base-100 mb-2" set:html={title} />
    )}
    {showSubscriberCount && (
      <p
        class="subscriber-count text-base-600 dark:text-base-400 mb-2 hidden"
        data-subscriber-count
      >
        Join <span class="subscriber-number"></span> subscribers today
      </p>
    )}
    {description && (
      <p class="text-base-600 dark:text-base-400 mb-6">
        {description}
      </p>
    )}
    <form
      id={formId}
      method="post"
      action={actionUrl}
      class="newsletter-form flex flex-col gap-4"
      data-newsletter-form
    >
      <input type="hidden" name="nonce" />
      <input type="hidden" name="l" value={listId} />
      <input type="hidden" name="signupPage" value={signupPage} />

      <div class="flex flex-col gap-3">
        <!-- Row 1: Email field (full width) -->
        <div class="w-full">
          <label for={`${formId}-email`} class="sr-only">Email address</label>
          <input
            type="email"
            name="email"
            id={`${formId}-email`}
            required
            placeholder={emailPlaceholder}
            class="form__input w-full h-[46px]"
            aria-required="true"
            aria-describedby={`${formId}-status`}
          />
        </div>

        {showName && (
          <div class="w-full">
            <label for={`${formId}-name`} class="sr-only">Name (optional)</label>
            <input
              type="text"
              name="name"
              id={`${formId}-name`}
              placeholder={namePlaceholder}
              class="form__input w-full h-[46px]"
            />
          </div>
        )}

        <!-- Row 2: ALTCHA + Subscribe button -->
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
          <!-- ALTCHA spam protection widget -->
          <div class="altcha-container flex-shrink-0">
            <altcha-widget
              challengeurl={altchaChallengeUrl}
              hidefooter
              hidelogo
            ></altcha-widget>
          </div>

          <Button
            type="submit"
            variant="primary"
            class="whitespace-nowrap flex-shrink-0 w-full sm:w-auto"
          >
            {buttonText}
          </Button>
        </div>
      </div>

      <div
        id={`${formId}-status`}
        class="newsletter-status text-sm"
        role="status"
        aria-live="polite"
      ></div>

      {note && (
        <p class="text-xs text-base-500 dark:text-base-400 mt-2">
          {note}
        </p>
      )}
    </form>
  </div>
)}

{variant === "cta" && (
  <section class="py-10" aria-labelledby={`${formId}-heading`}>
    <div class="site-container">
      <div
        class:list={[
          "relative overflow-hidden rounded-md bg-primary-500 px-4 sm:px-8 md:px-16 py-8 sm:py-11 md:py-14",
          className
        ]}
        role="region"
        aria-label="Newsletter signup"
      >
        <!-- Decorative elements -->
        <Icon
          name="atlas/dots3"
          class="absolute left-4 top-0 z-10 size-16 text-accent-4"
          aria-hidden="true"
          role="presentation"
        />
        <Icon
          name="atlas/dots3"
          class="absolute bottom-0 right-4 z-10 size-16 text-accent-4"
          aria-hidden="true"
          role="presentation"
        />
        <Icon
          name="atlas/wave-bg-basic"
          class="absolute left-1/2 top-1/2 h-full w-full max-w-full -translate-x-1/2 -translate-y-1/2 object-cover text-base-100/5"
          aria-hidden="true"
          role="presentation"
        />

        <div
          class="relative z-20 mx-auto flex max-w-2xl flex-col items-center gap-6 text-center"
        >
          {title && (
            <h2
              id={`${formId}-heading`}
              class="text-2xl sm:text-3xl md:text-4xl font-bold tracking-tighter text-base-100 dark:text-base-900"
              set:html={title}
            />
          )}
          {showSubscriberCount && (
            <p
              class="subscriber-count text-base-100/90 dark:text-base-900/90 font-medium hidden"
              data-subscriber-count
            >
              Join <span class="subscriber-number"></span> subscribers today
            </p>
          )}
          {description && (
            <p class="font-medium text-base-100/90 dark:text-base-900/90 max-w-lg">
              {description}
            </p>
          )}

          <form
            id={formId}
            method="post"
            action={actionUrl}
            class="newsletter-form w-full max-w-md"
            data-newsletter-form
          >
            <input type="hidden" name="nonce" />
            <input type="hidden" name="l" value={listId} />
            <input type="hidden" name="signupPage" value={signupPage} />

            <div class="flex flex-col gap-3">
              <!-- Row 1: Email field (full width) -->
              <div class="w-full max-w-md mx-auto">
                <label for={`${formId}-email`} class="sr-only">Email address</label>
                <input
                  type="email"
                  name="email"
                  id={`${formId}-email`}
                  required
                  placeholder={emailPlaceholder}
                  class="form__input w-full h-[46px] bg-base-100 dark:bg-base-900 text-base-900 dark:text-base-100 placeholder:text-base-500 border-transparent"
                  aria-required="true"
                  aria-describedby={`${formId}-status`}
                />
              </div>

              {showName && (
                <div class="w-full max-w-md mx-auto">
                  <label for={`${formId}-name`} class="sr-only">Name (optional)</label>
                  <input
                    type="text"
                    name="name"
                    id={`${formId}-name`}
                    placeholder={namePlaceholder}
                    class="form__input w-full h-[46px] bg-base-100 dark:bg-base-900 text-base-900 dark:text-base-100 placeholder:text-base-500 border-transparent"
                  />
                </div>
              )}

              <!-- Row 2: ALTCHA + Subscribe button -->
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-center gap-3 w-full max-w-md mx-auto">
                <!-- ALTCHA spam protection widget -->
                <div class="altcha-container altcha-container--cta flex-shrink-0">
                  <altcha-widget
                    challengeurl={altchaChallengeUrl}
                    hidefooter
                    hidelogo
                  ></altcha-widget>
                </div>

                <Button
                  type="submit"
                  variant="on-color"
                  class="whitespace-nowrap shadow-none flex-shrink-0 w-full sm:w-auto"
                >
                  {buttonText}
                </Button>
              </div>
            </div>

            <div
              id={`${formId}-status`}
              class="newsletter-status newsletter-status--cta text-sm mt-3"
              role="status"
              aria-live="polite"
            ></div>

            {note && (
              <p class="text-xs text-base-100/80 dark:text-base-900/80 mt-3">
                {note}
              </p>
            )}
          </form>
        </div>
      </div>
    </div>
  </section>
)}

{variant === "inline" && (
  <form
    id={formId}
    method="post"
    action={actionUrl}
    class:list={[
      "newsletter-form newsletter-inline flex flex-col gap-3",
      className
    ]}
    data-newsletter-form
  >
    <input type="hidden" name="nonce" />
    <input type="hidden" name="l" value={listId} />
    <input type="hidden" name="signupPage" value={signupPage} />

    <!-- Row 1: Email field (full width) -->
    <div class="w-full">
      <label for={`${formId}-email`} class="sr-only">Email address</label>
      <input
        type="email"
        name="email"
        id={`${formId}-email`}
        required
        placeholder={emailPlaceholder}
        class="form__input w-full h-[46px]"
        aria-required="true"
        aria-describedby={`${formId}-status`}
      />
    </div>

    {showName && (
      <div class="w-full">
        <label for={`${formId}-name`} class="sr-only">Name (optional)</label>
        <input
          type="text"
          name="name"
          id={`${formId}-name`}
          placeholder={namePlaceholder}
          class="form__input w-full h-[46px]"
        />
      </div>
    )}

    <!-- Row 2: ALTCHA + Subscribe button -->
    <div class="flex flex-col sm:flex-row sm:items-center gap-3">
      <!-- ALTCHA spam protection widget -->
      <div class="altcha-container flex-shrink-0">
        <altcha-widget
          challengeurl={altchaChallengeUrl}
          hidefooter
          hidelogo
        ></altcha-widget>
      </div>

      <Button
        type="submit"
        variant="primary"
        class="whitespace-nowrap w-full sm:w-auto flex-shrink-0"
      >
        {buttonText}
      </Button>
    </div>

    <div
      id={`${formId}-status`}
      class="newsletter-status text-sm w-full"
      role="status"
      aria-live="polite"
    ></div>
  </form>
)}

{variant === "minimal" && (
  <form
    id={formId}
    method="post"
    action={actionUrl}
    class:list={["newsletter-form newsletter-minimal", className]}
    data-newsletter-form
  >
    <input type="hidden" name="nonce" />
    <input type="hidden" name="l" value={listId} />
    <input type="hidden" name="signupPage" value={signupPage} />

    <div class="flex flex-col gap-3">
      <!-- Row 1: Email field (full width) -->
      <div>
        <label for={`${formId}-email`} class="sr-only">Email address</label>
        <input
          type="email"
          name="email"
          id={`${formId}-email`}
          required
          placeholder={emailPlaceholder}
          class="form__input w-full"
          aria-required="true"
          aria-describedby={`${formId}-status`}
        />
      </div>

      {showName && (
        <div>
          <label for={`${formId}-name`} class="sr-only">Name (optional)</label>
          <input
            type="text"
            name="name"
            id={`${formId}-name`}
            placeholder={namePlaceholder}
            class="form__input w-full"
          />
        </div>
      )}

      <!-- Row 2: ALTCHA + Subscribe button -->
      <div class="flex flex-col sm:flex-row sm:items-center gap-3">
        <!-- ALTCHA spam protection widget -->
        <div class="altcha-container flex-shrink-0">
          <altcha-widget
            challengeurl={altchaChallengeUrl}
            hidefooter
            hidelogo
          ></altcha-widget>
        </div>

        <Button
          type="submit"
          variant="primary"
          class="w-full sm:w-auto"
        >
          {buttonText}
        </Button>
      </div>

      <div
        id={`${formId}-status`}
        class="newsletter-status text-sm"
        role="status"
        aria-live="polite"
      ></div>
    </div>
  </form>
)}

<script>
  // Dynamically load ALTCHA widget script
  function loadAltchaScript() {
    if (document.querySelector('script[data-altcha]')) return;
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/altcha/dist/altcha.min.js';
    script.type = 'module';
    script.async = true;
    script.dataset.altcha = 'true';
    document.head.appendChild(script);
  }
  loadAltchaScript();

  class NewsletterFormHandler {
    private form: HTMLFormElement;
    private submitButton: HTMLButtonElement;
    private statusElement: HTMLElement;
    private originalButtonText: string;

    constructor(form: HTMLFormElement) {
      this.form = form;
      this.submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      this.statusElement = form.querySelector('.newsletter-status') as HTMLElement;
      this.originalButtonText = this.submitButton.querySelector('.button__text')?.textContent || 'Subscribe';

      this.init();
    }

    private init() {
      this.form.addEventListener('submit', this.handleSubmit.bind(this));

      // Validate email on input
      const emailInput = this.form.querySelector('input[type="email"]') as HTMLInputElement;
      emailInput?.addEventListener('input', () => this.validateEmail(emailInput));
    }

    private validateEmail(input: HTMLInputElement): boolean {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const isValid = emailRegex.test(input.value);

      input.setAttribute('aria-invalid', (!isValid && input.value.length > 0).toString());
      return isValid;
    }

    private setStatus(message: string, type: 'success' | 'error' | 'loading') {
      this.statusElement.textContent = message;

      // Check if this is a CTA variant (has special class - on teal background)
      const isCta = this.statusElement.classList.contains('newsletter-status--cta');

      // Reset classes but preserve base and CTA classes
      this.statusElement.className = isCta
        ? 'newsletter-status newsletter-status--cta text-sm mt-3'
        : 'newsletter-status text-sm mt-2';

      if (type === 'success') {
        // CTA: light text on teal background
        this.statusElement.classList.add(
          isCta ? 'text-base-100' : 'text-green-600',
          isCta ? 'dark:text-base-900' : 'dark:text-green-400',
          isCta ? 'font-medium' : ''
        );
      } else if (type === 'error') {
        // CTA: use a visible color on teal
        this.statusElement.classList.add(
          isCta ? 'text-red-100' : 'text-red-600',
          isCta ? 'dark:text-red-900' : 'dark:text-red-400',
          isCta ? 'font-medium' : ''
        );
      } else {
        this.statusElement.classList.add(
          isCta ? 'text-base-100/80' : 'text-base-500',
          isCta ? 'dark:text-base-900/80' : 'dark:text-base-400'
        );
      }
    }

    private setButtonState(loading: boolean) {
      this.submitButton.disabled = loading;
      const buttonText = this.submitButton.querySelector('.button__text');
      if (buttonText) {
        buttonText.textContent = loading ? 'Subscribing...' : this.originalButtonText;
      }
    }

    private async handleSubmit(e: Event) {
      e.preventDefault();

      const emailInput = this.form.querySelector('input[type="email"]') as HTMLInputElement;

      if (!this.validateEmail(emailInput)) {
        this.setStatus('Please enter a valid email address.', 'error');
        emailInput.focus();
        return;
      }

      this.setButtonState(true);
      this.setStatus('', 'loading');

      // Get ALTCHA solution from widget
      const altchaInput = this.form.querySelector('input[name="altcha"]') as HTMLInputElement;
      const altchaSolution = altchaInput?.value;

      if (!altchaSolution) {
        this.setStatus('Please wait for verification to complete.', 'error');
        this.setButtonState(false);
        return;
      }

      // Build JSON payload for our Netlify function
      const payload = {
        email: emailInput.value,
        listId: (this.form.querySelector('input[name="l"]') as HTMLInputElement)?.value,
        name: (this.form.querySelector('input[name="name"]') as HTMLInputElement)?.value || undefined,
        signupPage: (this.form.querySelector('input[name="signupPage"]') as HTMLInputElement)?.value || undefined,
        altcha: altchaSolution,
      };

      try {
        const response = await fetch(this.form.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });

        const result = await response.json();

        if (response.ok && result.success) {
          this.setStatus(result.message || 'Thanks for subscribing! Please check your email to confirm.', 'success');
          this.form.reset();

          // Reset button after delay
          setTimeout(() => {
            this.setButtonState(false);
          }, 2000);
        } else {
          this.setStatus(result.error || 'Something went wrong. Please try again.', 'error');
          this.setButtonState(false);
        }

      } catch {
        this.setStatus('Something went wrong. Please try again.', 'error');
        this.setButtonState(false);
      }
    }
  }

  // Initialize all newsletter forms
  function initNewsletterForms() {
    document.querySelectorAll<HTMLFormElement>('[data-newsletter-form]').forEach(form => {
      // Avoid re-initializing
      if (!form.dataset.initialized) {
        new NewsletterFormHandler(form);
        form.dataset.initialized = 'true';
      }
    });
  }

  // Fetch and display subscriber count
  async function fetchSubscriberCount() {
    try {
      const response = await fetch('/.netlify/functions/newsletter-stats');
      const data = await response.json();

      if (data.success && data.subscriberCount && data.subscriberCount > 10) {
        document.querySelectorAll('[data-subscriber-count]').forEach(el => {
          const numberEl = el.querySelector('.subscriber-number');
          if (numberEl) {
            numberEl.textContent = data.subscriberCount.toLocaleString();
            el.classList.remove('hidden');
          }
        });
      }
    } catch {
      // Silently fail - don't show count if fetch fails
    }
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    loadAltchaScript();
    initNewsletterForms();
    fetchSubscriberCount();
  });

  // Re-initialize after Astro view transitions
  document.addEventListener('astro:after-swap', () => {
    loadAltchaScript();
    initNewsletterForms();
    fetchSubscriberCount();
  });
</script>

<style>
  .newsletter-form input[aria-invalid="true"] {
    @apply border-red-500 dark:border-red-400;
  }

  .newsletter-form input:focus-visible {
    @apply outline-none ring-2 ring-primary-500 ring-offset-2;
  }

  .newsletter-status:empty {
    display: none;
  }

  /* CTA variant specific styles */
  .newsletter-status--cta {
    text-align: center;
  }

  /* ALTCHA widget styling - inline with form elements */
  .altcha-container {
    /* No margin needed when inline */
  }

  .altcha-container--cta {
    /* Centered in CTA variant */
  }

  /* Make ALTCHA widget blend with form design - remove border per UX recommendation */
  :global(altcha-widget) {
    --altcha-max-width: 100%;
    --altcha-border-width: 0;
    --altcha-border-radius: 0;
    --altcha-color-border: transparent;
    --altcha-color-border-focus: transparent;
    --altcha-color-active: #f6c177;
  }

  /* ALTCHA checkbox - gold checkmark */
  :global(altcha-widget .altcha-checkbox input[type="checkbox"]) {
    accent-color: #f6c177 !important;
  }

  /* Filter to shift blue checkbox to rosé-pine gold (~36° hue) */
  /* Blue ~220° to gold ~36° = rotate ~176°, with saturation boost for vibrancy */
  :global(altcha-widget .altcha-checkbox input[type="checkbox"]:checked) {
    filter: hue-rotate(165deg) saturate(1.5) brightness(1.1) !important;
  }

  /* Ensure ALTCHA checkbox is clearly visible without container border */
  .altcha-container {
    display: flex;
    align-items: center;
  }

  /* High contrast mode support */
  @media (forced-colors: active) {
    .newsletter-form input {
      border: 1px solid CanvasText;
    }

    .newsletter-form input[aria-invalid="true"] {
      border: 2px solid CanvasText;
    }
  }

  /* Gold hover for newsletter subscribe buttons */
  .newsletter-form :global(.button--primary:hover) {
    background-color: #ea9d34 !important;
  }
  :global(.dark) .newsletter-form :global(.button--primary:hover) {
    background-color: #f6c177 !important;
    color: #191724 !important;
  }

  /* On-color variant (CTA) - gold hover */
  .newsletter-form :global(.button--on-color:hover) {
    background-color: #f6c177 !important;
    border-color: #f6c177 !important;
    color: #191724 !important;
  }
  :global(.dark) .newsletter-form :global(.button--on-color:hover) {
    background-color: #ea9d34 !important;
    border-color: #ea9d34 !important;
    color: #191724 !important;
  }
</style>
