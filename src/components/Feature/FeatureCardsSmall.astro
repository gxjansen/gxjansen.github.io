---
/**
 * * These are small cards with icons, titles, and text. With title first
 * This looks best with an even number of cards. They are smaller to
 * use with more cards in the same section. 4 or 6 cards is probably ideal
 *
 * ! I copy all icons into the src/icons folder and recommend you do the same
 * ! If the icon is at src/icons/tabler/paint.svg then you put in "tabler/paint"
 */

import { Icon } from "astro-icon";

// components
import FeatureCard from "@components/FeatureCard/FeatureCardSmall.astro";
import Badge from "@components/Badge/Badge.astro";

interface FeatureData {
  icon: string;
  title: string;
  text: string;
}

// data
const featureData: FeatureData[] = [
  {
    icon: "tabler/outline/building-estate",
    title: "Community Building & Strategy",
    text: `I build community functions - the strategy, the systems, and the teams to run them. By combining psychological insights with strategic technology choices, I help organizations build ecosystems that strengthen under pressure, reducing support costs while accelerating platform adoption.`,
  },
  {
    icon: "tabler/outline/users",
    title: "Executive Advisory for Developer-Led Growth",
    text: `I guide C-suite leaders through the shift from product-first to community-first strategies. My psychology background reveals the behavioral drivers that determine ecosystem success, informing decisions worth millions in market positioning and long-term differentiation.`,
  },
  {
    icon: "tabler/outline/transform",
    title: "Organizational Transformation",
    text: `I help companies restructure around community-led growth, aligning engineering, marketing, and business development for ecosystem success. This includes designing measurement frameworks, incentive models, and cross-functional processes that scale community impact without proportional resource increases.`,
  },
];

// Check for reduced motion preference
const reducedMotionQuery = "(prefers-reduced-motion: reduce)";
const shouldReduceMotion =
  typeof window !== "undefined"
    ? window.matchMedia(reducedMotionQuery).matches
    : false;
---

<section
  id="feature-cards-small"
  class="py-24 md:py-28"
  aria-labelledby="features-heading"
>
  <div class="relative" role="presentation">
    <div class="mx-auto mb-16 text-center md:max-w-4xl">
      <Badge>Strategic Impact</Badge>
      <h2 id="features-heading" class="h2 mb-4">Strategic Impact Areas</h2>
      <p
        class="description text-pretty text-lg md:text-xl"
        aria-describedby="features-heading"
      >
        Transform your ecosystem into a strategic growth engine
      </p>
    </div>
    {/* Desktop Grid Layout */}
    <div
      class="site-container hidden gap-6 lg:grid lg:grid-cols-3"
      role="list"
      aria-label="Services grid"
    >
      {
        featureData.map((feature, idx) => (
          <div role="listitem">
            <FeatureCard
              title={feature.title}
              text={feature.text}
              icon={feature.icon}
              suffix="-desktop"
            />
          </div>
        ))
      }
    </div>

    {/* Mobile/Tablet Carousel */}
    <div
      class="scroll-container-wrapper site-container lg:hidden"
      id="feature-cards-carousel"
    >
      <div class="relative">
        <div class="carousel-header">
          <span
            class="sr-only"
            role="status"
            aria-live="polite"
            id="carousel-status"
          >
            Services carousel. Use left and right arrow buttons or swipe to
            navigate through items.
          </span>

          <div
            class="carousel-progress"
            role="progressbar"
            aria-label="Services carousel progress"
            aria-labelledby="carousel-status"
            aria-valuemin="1"
            aria-valuemax={featureData.length}
            aria-valuenow="1"
            id="services-carousel-progress"
          >
            {
              featureData.map((_, idx) => (
                <div
                  class="progress-dot"
                  data-active={idx === 0 ? "true" : "false"}
                  aria-hidden="true"
                />
              ))
            }
          </div>
        </div>

        <button
          class="nav-button left-button"
          aria-label={`View previous items. Currently at item 1 of ${featureData.length}`}
          disabled
        >
          <span aria-hidden="true">❮</span>
        </button>

        <div
          class="scroll-container"
          role="list"
          aria-label={`Feature cards carousel with ${featureData.length} items`}
          tabindex="0"
          id="feature-cards-container"
        >
          {
            featureData.map((feature, idx) => (
              <div class="scroll-item" role="listitem">
                <FeatureCard
                  title={feature.title}
                  text={feature.text}
                  icon={feature.icon}
                  suffix="-mobile"
                />
              </div>
            ))
          }
        </div>

        <button class="nav-button right-button" aria-label="Next items">
          <span aria-hidden="true">❯</span>
        </button>
      </div>
    </div>

    <script define:vars={{ totalItems: featureData.length }}>
      // Handle carousel navigation
      const wrapper = document.querySelector("#feature-cards-carousel");
      const container = wrapper?.querySelector("#feature-cards-container");
      const leftButton = wrapper?.querySelector(".left-button");
      const rightButton = wrapper?.querySelector(".right-button");

      if (wrapper && container && leftButton && rightButton) {
        const scrollAmount = container.clientWidth * 0.8; // 80% of container width
        const progressDots = wrapper?.querySelectorAll(".progress-dot");

        const updateCarouselState = () => {
          if (!container || !leftButton || !rightButton || !progressDots)
            return;

          const isAtStart = container.scrollLeft <= 10;
          const isAtEnd =
            container.scrollLeft + container.clientWidth >=
            container.scrollWidth - 10;

          // Update button states
          leftButton.disabled = isAtStart;
          rightButton.disabled = isAtEnd;
          leftButton.setAttribute("aria-disabled", isAtStart.toString());
          rightButton.setAttribute("aria-disabled", isAtEnd.toString());

          // Calculate current item index
          const scrollPercentage =
            container.scrollLeft /
            (container.scrollWidth - container.clientWidth);
          const currentIndex = Math.round(scrollPercentage * (totalItems - 1));

          // Update progress dots
          progressDots.forEach((dot, idx) => {
            dot.setAttribute("data-active", (idx === currentIndex).toString());
          });

          // Update ARIA labels
          leftButton.setAttribute(
            "aria-label",
            `View previous items. Currently at item ${currentIndex + 1} of ${totalItems}`,
          );
          rightButton.setAttribute(
            "aria-label",
            `View next items. Currently at item ${currentIndex + 1} of ${totalItems}`,
          );

          // Update screen reader status and progressbar
          const status = wrapper?.querySelector('[role="status"]');
          const progressbar = wrapper?.querySelector('[role="progressbar"]');

          if (status) {
            status.textContent = `Viewing item ${currentIndex + 1} of ${totalItems}. Use left and right arrow buttons or swipe to navigate.`;
          }

          if (progressbar) {
            progressbar.setAttribute(
              "aria-valuenow",
              (currentIndex + 1).toString(),
            );
            progressbar.setAttribute(
              "aria-valuetext",
              `Item ${currentIndex + 1} of ${totalItems}`,
            );
          }
        };

        // Button click handlers with improved feedback
        leftButton.addEventListener("click", (e) => {
          e.stopPropagation();
          container.scrollBy({ left: -scrollAmount, behavior: "smooth" });
          updateCarouselState();
        });

        rightButton.addEventListener("click", (e) => {
          e.stopPropagation();
          container.scrollBy({ left: scrollAmount, behavior: "smooth" });
          updateCarouselState();
        });

        // Keyboard navigation
        container.addEventListener("keydown", (e) => {
          if (e.key === "ArrowLeft") {
            container.scrollBy({ left: -scrollAmount, behavior: "smooth" });
          } else if (e.key === "ArrowRight") {
            container.scrollBy({ left: scrollAmount, behavior: "smooth" });
          }
        });

        // Update carousel state on scroll, resize, and after animations
        container.addEventListener("scroll", updateCarouselState, {
          passive: true,
        });
        window.addEventListener("resize", updateCarouselState, {
          passive: true,
        });
        container.addEventListener("scrollend", updateCarouselState);

        // Initial state
        updateCarouselState();

        // Touch swipe feedback
        container.addEventListener(
          "touchstart",
          () => {
            container.style.scrollSnapType = "none"; // Disable snap during swipe
          },
          { passive: true },
        );

        container.addEventListener(
          "touchend",
          () => {
            container.style.scrollSnapType = "x mandatory"; // Re-enable snap after swipe
            updateCarouselState();
          },
          { passive: true },
        );
      }
    </script>
  </div>
</section>
