---
import { type CollectionEntry, getEntries } from "astro:content";
import { Image } from "astro:assets";
import { getRelativeLocaleUrl } from "astro:i18n";
import { YouTube } from 'astro-embed';

// main layout
import BaseLayout from "./BaseLayout.astro";

// components
import Button from "@components/Button/Button.astro";
import Category from "@components/Category/Category.astro";
import BlogNav from "@components/Blog/BlogNav.astro";
import NewsletterForm from "@components/Newsletter/NewsletterForm.astro";
import AuthorByline from "@components/Author/AuthorByline.astro";
import AuthorBioBox from "@components/Author/AuthorBioBox.astro";

// utils
import { formatDate, humanize, slugify } from "@js/textUtils";
import { getLocaleFromUrl } from "@js/localeUtils";
import { useTranslations } from "@js/translationUtils";
import { filterCategoriesByCount } from "@js/blogUtils";

// images
import HumanNotAI from "@images/Written-By-Human-Not-By-AI-Badge-black.svg";

interface Props {
  post: CollectionEntry<"post">;
  allPosts: CollectionEntry<"post">[];
  transitionName?: string;
}

const { post, allPosts, transitionName } = Astro.props;
const {
  title,
  description,
  authors = [],
  categories = [],
  pubDate,
  updatedDate,
  heroImage,
} = post.data;

const currLocale = getLocaleFromUrl(Astro.url);
const t = useTranslations(currLocale);
const authorsData = authors && authors.length > 0 ? await getEntries(authors.map(author => ({ collection: 'authors', id: author }))) : [];

// Filter categories to only show those with 2+ posts
const filteredCategories = filterCategoriesByCount(categories, allPosts);
---

<BaseLayout
  type="blog"
  title={title}
  description={description}
  image={heroImage}
  authorsData={authorsData}
  postFrontmatter={post.data}
>
  <article 
    class="mt-24"
    aria-labelledby="article-title"
    itemscope 
    itemtype="https://schema.org/BlogPosting"
  >
    <div class="relative">
        <!-- Blog post info -->
        <div class="flex w-full flex-col items-center px-4">
          <div class="mx-auto flex w-full max-w-2xl">
            <div class="mx-auto max-w-full text-center">
              <!-- Categories -->
              <div
                class="flex justify-center gap-4"
                role="list"
                aria-label="Article categories"
              >
                {filteredCategories.map((category) => <Category category={category} />)}
              </div>

              <!-- title -->
              <h1 id="article-title" class="h1 mt-6" itemprop="headline">{title}</h1>

              <div
                class="mt-6 flex w-full flex-wrap justify-center gap-4 items-center font-medium text-base-500 dark:text-base-400"
              >
                <!-- Author info -->
                <div class="flex flex-wrap gap-4 items-center">
                  {authorsData.map((authorData, index) => (
                    <>
                      <AuthorByline author={authorData} showBio={false} variant="compact" />
                      {index < authorsData.length - 1 && <span class="text-base-400">&</span>}
                    </>
                  ))}
                </div>

                {authorsData.length > 0 && pubDate && <span class="text-base-400">&bull;</span>}

                <!-- Date -->
                {pubDate && (
                  <time
                    class="my-auto h-full"
                    datetime={pubDate instanceof Date ? pubDate.toISOString() : pubDate}
                    itemprop="datePublished"
                  >
                    <span aria-label="Published on">{formatDate(pubDate, currLocale)}</span>
                  </time>
                )}
              </div>
            </div>
          </div>
          <div class="flex justify-center pt-5">
            <a href="https://notbyai.fyi/" target="_blank" rel="noopener noreferrer">
              <Image
                src={HumanNotAI}
                alt="Written-By-Human-Not-By-AI"
                decoding="async"
                loading="lazy"
                width={100}
              />
            </a>
          </div>
          <!-- blog post main image -->
          {heroImage && (
            <div class="mt-6 w-full max-w-2xl overflow-hidden">
              <Image
                src={heroImage}
                alt={heroImage.alt || `Cover image for article: ${title}`}
                widths={[640, 768, 1024, 1600, 2000]}
                sizes="(max-width: 1024px) 100vw, 1000px"
                class="max-h-[70vh] w-full rounded-xl object-cover"
                loading="eager"
                fetchpriority="high"
                transition:name={transitionName}
                itemprop="image"
                quality={90}
                format="webp"
              />
            </div>
          )}
        </div>
      </div>
    </div>

    <!-- article content -->
    <div class="mt-10 w-full px-4">
      <div class="mx-auto max-w-2xl">
        <div class="text-base-900 dark:text-base-100 text-base">
          {
            updatedDate && (
              <div class="mb-6 italic">
                <time datetime={updatedDate instanceof Date ? updatedDate.toISOString() : updatedDate}>
                  {t("updated")}: {formatDate(updatedDate, currLocale)}
                </time>
              </div>
            )
          }
          <section
            id="blog-post-content"
            class="prose mx-auto"
            itemprop="articleBody"
            aria-label="Article content"
          >
            <slot />
          </section>
        </div>

        <!-- Author Bio Box -->
        {authorsData.length > 0 && (
          <div class="mx-auto max-w-2xl">
            {authorsData.map(authorData => (
              <AuthorBioBox author={authorData} />
            ))}
          </div>
        )}
    </div>
  </article>

  <!-- Newsletter CTA -->
  <div class="mt-16 site-container">
    <NewsletterForm
      variant="card"
      title="Enjoyed this article?"
      description="Get notified when I publish new insights on community building, ecosystems, and business strategy. No spam, no tracking pixels, unsubscribe anytime."
    />
  </div>

  <!-- Navigation -->
  <nav 
    class="mx-auto max-w-2xl"
    aria-label="Blog post navigation"
  >
    <BlogNav currentSlug={post.slug} posts={allPosts} />
  </nav>
</BaseLayout>
