---
import { type CollectionEntry } from "astro:content";

// component imports
import BaseHead from "@layouts/BaseHead.astro";
import { ViewTransitions } from 'astro:transitions';
import Nav from "@components/Nav/Nav.astro";
import Footer from "@components/Footer/Footer.astro";
import CookieConsent from "@components/CookieConsent/CookieConsent.astro";
import EnvironmentBanner from '../components/EnvironmentBanner/EnvironmentBanner.astro';

// style import
import "../styles/global.scss";

// utils
import { getLocaleFromUrl } from "@js/localeUtils";

// data
import siteSettings from "@config/siteSettings.json";

// heroImage and authorData are defined on blog posts
// authorData could also be defined on the about author page
interface Props {
  type?: "blog" | "general";
  title: string;
  description: string;
  image?: ImageMetadata;
  authorsData?: CollectionEntry<"authors">[];
  postFrontmatter?: CollectionEntry<"post">["data"];
  noindex?: boolean; // you need to opt-in to no indexing, as it hides the page from search engines
}

const {
  type = "general",
  title,
  description,
  image,
  authorsData,
  postFrontmatter,
  noindex = false,
} = Astro.props as Props;

const currLocale = getLocaleFromUrl(Astro.url);
---

<!doctype html>
<html lang={currLocale}>
  <head>
    <BaseHead
      type={type}
      title={title}
      description={description}
      image={image ? image : undefined}
      authors={authorsData ? authorsData : undefined}
      postFrontmatter={postFrontmatter ? postFrontmatter : undefined}
      noindex={noindex}
    />
    <ViewTransitions />
    <style>
      /* Performance optimizations for transitions */
      .transition-ready {
        will-change: opacity, transform;
        transform: translateZ(0);
        backface-visibility: hidden;
      }

      /* Noise background animation */
      @keyframes noise {
        0% { transform: translate(0,0) }
        10% { transform: translate(-5%,-5%) }
        20% { transform: translate(-10%,5%) }
        30% { transform: translate(5%,-10%) }
        40% { transform: translate(-5%,15%) }
        50% { transform: translate(-10%,5%) }
        60% { transform: translate(15%,0) }
        70% { transform: translate(0,10%) }
        80% { transform: translate(-15%,0) }
        90% { transform: translate(10%,5%) }
        100% { transform: translate(5%,0) }
      }
    </style>
  </head>
  <body
    id="body"
    class={`bg-background dark:bg-background-dark ${
      siteSettings.useAnimations === true ? "use-animations" : ""
    } relative isolate overflow-x-hidden`}
  >
    {/* Noise overlay */}
    <div class="pointer-events-none fixed inset-0 -z-20 opacity-[0.2] [background-size:150px_150px]" style="background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIj48ZmlsdGVyIGlkPSJhIiB4PSIwIiB5PSIwIj48ZmVUdXJidWxlbmNlIGJhc2VGcmVxdWVuY3k9Ii43NSIgc3RpdGNoVGlsZXM9InN0aXRjaCIgdHlwZT0iZnJhY3RhbE5vaXNlIi8+PGZlQ29sb3JNYXRyaXggdHlwZT0ic2F0dXJhdGUiIHZhbHVlcz0iMCIvPjwvZmlsdGVyPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbHRlcj0idXJsKCNhKSIgb3BhY2l0eT0iLjA1Ii8+PC9zdmc+');"></div>

    <!-- Top-left gradient with extended fade -->
    <div class="fixed -top-[400px] -left-[400px] -z-10 h-[1200px] w-[1200px] bg-[radial-gradient(circle_at_30%_30%,rgba(20,184,166,0.15)_0%,rgba(20,184,166,0.1)_10%,rgba(20,184,166,0.05)_20%,rgba(20,184,166,0.025)_30%,rgba(20,184,166,0.01)_40%,rgba(20,184,166,0.005)_50%,transparent_70%)] dark:bg-[radial-gradient(circle_at_30%_30%,rgba(20,184,166,0.08)_0%,rgba(20,184,166,0.06)_10%,rgba(20,184,166,0.04)_20%,rgba(20,184,166,0.02)_30%,rgba(20,184,166,0.01)_40%,rgba(20,184,166,0.005)_50%,transparent_70%)]" />
    
    <!-- Bottom-right gradient with extended fade -->
    <div class="fixed -bottom-[400px] -right-[400px] -z-10 h-[1200px] w-[1200px] bg-[radial-gradient(circle_at_70%_70%,rgba(20,184,166,0.15)_0%,rgba(20,184,166,0.1)_10%,rgba(20,184,166,0.05)_20%,rgba(20,184,166,0.025)_30%,rgba(20,184,166,0.01)_40%,rgba(20,184,166,0.005)_50%,transparent_70%)] dark:bg-[radial-gradient(circle_at_70%_70%,rgba(20,184,166,0.08)_0%,rgba(20,184,166,0.06)_10%,rgba(20,184,166,0.04)_20%,rgba(20,184,166,0.02)_30%,rgba(20,184,166,0.01)_40%,rgba(20,184,166,0.005)_50%,transparent_70%)]" />

    <EnvironmentBanner />
    <!-- put cookie consent first so it is seen first by screen readers -->
    <!-- <CookieConsent /> -->
    <div class="min-h-[100lvh] relative">
      {/* Background grid pattern */}
      <div class="fixed inset-0" style="z-index: -9999;">
        <div class="grid-pattern-container h-full w-full" />
      </div>
      
      {/* Main content */}
      <div class="relative" style="z-index: 1;">
        <Nav />
        <div class="site-container px-4">
          <main class="transition-ready" transition:animate="fade" transition:animate.duration="0.2" transition:animate.timing="ease-out">
            <slot />
          </main>
          <Footer />
        </div>
      </div>
    </div>

    <!-- Performance optimizations -->
    <script>
      // Inform the browser about upcoming transitions
      document.addEventListener('astro:before-preparation', () => {
        document.querySelectorAll('.transition-ready').forEach(el => {
          el.style.willChange = 'opacity, transform';
        });
      });

      // Clean up after transition
      document.addEventListener('astro:after-swap', () => {
        document.querySelectorAll('.transition-ready').forEach(el => {
          el.style.willChange = 'auto';
        });
      });

      // Scroll animations
      import siteSettings from "@config/siteSettings.json";
      import AOS from "@js/aos/aos";

      if (siteSettings.useAnimations === true) {
        // runs on initial page load
        AOS.init({ once: true, duration: 0.75, distance: 100, offset: 120 });

        // runs on view transitions navigation
        document.addEventListener("astro:after-swap", AOS.refreshHard);
      }
    </script>
  </body>
</html>
